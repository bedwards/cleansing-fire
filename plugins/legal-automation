#!/usr/bin/env python3
"""
Cleansing Fire Plugin: Legal Automation

Civic legal automation tools for generating legally-informed documents:
- FOIA request generation (federal, state, local)
- Regulatory complaint drafting (FTC, FCC, SEC, EPA, CFPB, state AG)
- Know-your-rights information cards
- Cease-and-desist response templates
- Public comment generation for regulatory proceedings

The principle: legal literacy is a weapon against opacity. The mechanisms
of accountability -- FOIA, public comment, regulatory complaint -- are
available to everyone but used effectively by few. This plugin lowers
the barrier. It does not replace a lawyer. It arms you with language.

Built on research from docs/digital-rights-law.md and the Pyrrhic
Lucidity framework: acknowledge complicity, refuse simplification,
demand action anyway.

Plugin manifest:
  name: legal-automation
  category: civic
  actions: [foia-generate, complaint-draft, rights-card,
            cease-desist-respond, public-comment]
  requires_env: []
  uses_gatekeeper: true

Input JSON:
  {"action": "foia-generate", "agency": "...", "subject": "...",
   "date_range": "...", "specifics": "..."}
  {"action": "complaint-draft", "type": "FTC|FCC|SEC|EPA|CFPB|state-AG",
   "subject": "...", "facts": [...], "evidence": [...]}
  {"action": "rights-card", "scenario": "protest|police-encounter|...",
   "state": "..."}
  {"action": "cease-desist-respond", "threat_type": "defamation|copyright|...",
   "original_text": "...", "our_position": "..."}
  {"action": "public-comment", "docket": "...", "agency": "...",
   "position": "...", "facts": [...]}

Output JSON: {"content": "...", "metadata": {...}, "next_steps": [...],
              "disclaimer": "..."}

IMPORTANT: This plugin generates templates and informational content.
It does NOT provide legal advice. Output must always carry disclaimers.
"""

import json
import os
import sys
import urllib.request
from datetime import datetime, timezone

# ---------------------------------------------------------------------------
# Configuration
# ---------------------------------------------------------------------------

GATEKEEPER_URL = os.environ.get("CF_GATEKEEPER_URL", "http://127.0.0.1:7800")

LEGAL_DISCLAIMER = (
    "DISCLAIMER: This document was generated by an automated tool and does NOT "
    "constitute legal advice. It is provided for informational and educational "
    "purposes only. No attorney-client relationship is created by using this "
    "tool. Laws vary by jurisdiction and change over time. Before taking any "
    "legal action, consult a licensed attorney in your jurisdiction who can "
    "evaluate your specific situation. For free or low-cost legal assistance, "
    "contact organizations listed in the next_steps field."
)

LEGAL_SYSTEM_PROMPT = (
    "You are a legal document drafting assistant for the Cleansing Fire "
    "civic technology project. You generate professional, formally worded "
    "legal documents and templates. You cite actual statutes, regulations, "
    "and case law accurately. You NEVER claim to provide legal advice. "
    "You always note that the output is a template requiring review by a "
    "licensed attorney. Your tone is formal, precise, and authoritative. "
    "You use plain English where possible but include proper legal "
    "terminology where necessary for accuracy and enforceability."
)

# ---------------------------------------------------------------------------
# FOIA configuration: agency addresses, statutes, and templates
# ---------------------------------------------------------------------------

FOIA_STATUTES = {
    "federal": {
        "statute": "5 U.S.C. Section 552",
        "name": "Freedom of Information Act (FOIA)",
        "fee_waiver_basis": (
            "5 U.S.C. Section 552(a)(4)(A)(iii) -- disclosure is in the "
            "public interest because it is likely to contribute significantly "
            "to public understanding of the operations or activities of the "
            "government and is not primarily in the commercial interest of "
            "the requester."
        ),
        "expedited_basis": (
            "5 U.S.C. Section 552(a)(6)(E) -- there is a compelling need "
            "for expedited processing, including an urgency to inform the "
            "public concerning actual or alleged Federal Government activity."
        ),
        "response_deadline": "20 business days",
        "appeal_statute": "5 U.S.C. Section 552(a)(6)(A)",
    },
    "state": {
        "statute": "Varies by state -- see state public records act",
        "name": "State Public Records Request",
        "common_statutes": {
            "CA": "California Public Records Act, Cal. Gov. Code Section 6250 et seq.",
            "TX": "Texas Public Information Act, Tex. Gov. Code Section 552",
            "FL": "Florida Sunshine Law, Fla. Stat. Section 119",
            "NY": "Freedom of Information Law (FOIL), N.Y. Pub. Off. Law Section 84 et seq.",
            "IL": "Freedom of Information Act, 5 ILCS 140",
            "PA": "Right-to-Know Law, 65 P.S. Section 67.101 et seq.",
            "OH": "Ohio Public Records Act, Ohio Rev. Code Section 149.43",
            "WA": "Washington Public Records Act, RCW 42.56",
            "OR": "Oregon Public Records Law, ORS 192.311-192.478",
            "CO": "Colorado Open Records Act, C.R.S. Section 24-72-201 et seq.",
        },
    },
    "local": {
        "statute": "Varies -- typically governed by state public records law",
        "name": "Local Public Records Request",
    },
}

FEDERAL_AGENCY_FOIA_CONTACTS = {
    "DOJ": "U.S. Department of Justice, Office of Information Policy",
    "FBI": "Federal Bureau of Investigation, FOIA/PA Section",
    "DHS": "Department of Homeland Security, FOIA Office",
    "EPA": "Environmental Protection Agency, National FOIA Office",
    "DOD": "Department of Defense, FOIA Requester Service Center",
    "DOS": "Department of State, Office of Information Programs and Services",
    "FTC": "Federal Trade Commission, FOIA/PA Request",
    "FCC": "Federal Communications Commission, FOIA Office",
    "SEC": "Securities and Exchange Commission, FOIA/PA Office",
    "CFPB": "Consumer Financial Protection Bureau, FOIA Office",
    "IRS": "Internal Revenue Service, FOIA Request",
    "CIA": "Central Intelligence Agency, Information and Privacy Coordinator",
    "ICE": "U.S. Immigration and Customs Enforcement, FOIA Office",
}

# ---------------------------------------------------------------------------
# Regulatory complaint configuration
# ---------------------------------------------------------------------------

COMPLAINT_AGENCIES = {
    "FTC": {
        "name": "Federal Trade Commission",
        "jurisdiction": "Unfair or deceptive acts or practices, antitrust, consumer protection",
        "statute": "15 U.S.C. Section 45 (FTC Act, Section 5)",
        "filing_url": "https://reportfraud.ftc.gov/",
        "additional_statutes": [
            "15 U.S.C. Section 41 et seq. (FTC Act)",
            "15 U.S.C. Section 1 et seq. (Sherman Act)",
            "15 U.S.C. Section 1681 et seq. (Fair Credit Reporting Act)",
            "16 C.F.R. Part 255 (Endorsement Guides)",
        ],
    },
    "FCC": {
        "name": "Federal Communications Commission",
        "jurisdiction": "Telecommunications, broadcasting, media regulation, net neutrality",
        "statute": "47 U.S.C. Section 151 et seq. (Communications Act of 1934)",
        "filing_url": "https://consumercomplaints.fcc.gov/",
        "additional_statutes": [
            "47 U.S.C. Section 222 (Customer Proprietary Network Information)",
            "47 U.S.C. Section 227 (Telephone Consumer Protection Act)",
            "47 U.S.C. Section 338 (Carriage of Local Television Signals)",
        ],
    },
    "SEC": {
        "name": "Securities and Exchange Commission",
        "jurisdiction": "Securities fraud, market manipulation, insider trading, corporate disclosure",
        "statute": "15 U.S.C. Section 78u-6 (Dodd-Frank Whistleblower Program)",
        "filing_url": "https://www.sec.gov/whistleblower",
        "additional_statutes": [
            "15 U.S.C. Section 77a et seq. (Securities Act of 1933)",
            "15 U.S.C. Section 78a et seq. (Securities Exchange Act of 1934)",
            "18 U.S.C. Section 1514A (Sarbanes-Oxley Section 806)",
            "17 C.F.R. Section 240.10b-5 (Rule 10b-5, anti-fraud)",
        ],
    },
    "EPA": {
        "name": "Environmental Protection Agency",
        "jurisdiction": "Environmental violations, pollution, hazardous waste, Clean Air/Water Act",
        "statute": "Various -- see specific environmental statutes",
        "filing_url": "https://echo.epa.gov/report-environmental-violations",
        "additional_statutes": [
            "42 U.S.C. Section 7401 et seq. (Clean Air Act)",
            "33 U.S.C. Section 1251 et seq. (Clean Water Act)",
            "42 U.S.C. Section 6901 et seq. (RCRA, hazardous waste)",
            "42 U.S.C. Section 9601 et seq. (CERCLA/Superfund)",
            "15 U.S.C. Section 2601 et seq. (Toxic Substances Control Act)",
        ],
    },
    "CFPB": {
        "name": "Consumer Financial Protection Bureau",
        "jurisdiction": "Consumer financial products, predatory lending, debt collection, credit reporting",
        "statute": "12 U.S.C. Section 5481 et seq. (Dodd-Frank Title X)",
        "filing_url": "https://www.consumerfinance.gov/complaint/",
        "additional_statutes": [
            "15 U.S.C. Section 1601 et seq. (Truth in Lending Act)",
            "15 U.S.C. Section 1692 et seq. (Fair Debt Collection Practices Act)",
            "12 U.S.C. Section 2601 et seq. (Real Estate Settlement Procedures Act)",
            "15 U.S.C. Section 1681 et seq. (Fair Credit Reporting Act)",
        ],
    },
    "state-AG": {
        "name": "State Attorney General",
        "jurisdiction": "State consumer protection, antitrust, civil rights, environmental enforcement",
        "statute": "Varies by state -- typically state consumer protection act and AG enabling statute",
        "filing_url": "Varies by state -- search '[state] attorney general consumer complaint'",
        "additional_statutes": [
            "State Unfair and Deceptive Acts and Practices (UDAP) statutes",
            "State antitrust statutes",
            "State data breach notification laws",
        ],
    },
}

# ---------------------------------------------------------------------------
# Rights card configuration
# ---------------------------------------------------------------------------

RIGHTS_SCENARIOS = {
    "protest": {
        "title": "Know Your Rights: Protests and Demonstrations",
        "primary_amendments": ["First Amendment (free speech, assembly, petition)",
                               "Fourth Amendment (unreasonable search and seizure)",
                               "Fourteenth Amendment (equal protection, due process)"],
        "key_statutes": [
            "42 U.S.C. Section 1983 (civil rights violations by state actors)",
            "18 U.S.C. Section 242 (criminal deprivation of rights under color of law)",
            "18 U.S.C. Section 245 (federally protected activities)",
        ],
    },
    "police-encounter": {
        "title": "Know Your Rights: Police Encounters",
        "primary_amendments": ["Fourth Amendment (search and seizure)",
                               "Fifth Amendment (self-incrimination, due process)",
                               "Sixth Amendment (right to counsel)"],
        "key_statutes": [
            "Miranda v. Arizona, 384 U.S. 436 (1966)",
            "Terry v. Ohio, 392 U.S. 1 (1968) (stop and frisk standards)",
            "42 U.S.C. Section 1983 (civil rights violations)",
        ],
    },
    "workplace": {
        "title": "Know Your Rights: Workplace and Employment",
        "primary_amendments": ["First Amendment (public employee speech, limited)",
                               "Fourteenth Amendment (due process for public employees)"],
        "key_statutes": [
            "29 U.S.C. Section 151 et seq. (National Labor Relations Act)",
            "42 U.S.C. Section 2000e et seq. (Title VII, employment discrimination)",
            "29 U.S.C. Section 215(a)(3) (FLSA anti-retaliation)",
            "5 U.S.C. Section 2302(b)(8) (Whistleblower Protection Act)",
        ],
    },
    "digital-privacy": {
        "title": "Know Your Rights: Digital Privacy",
        "primary_amendments": ["Fourth Amendment (digital search and seizure)",
                               "First Amendment (anonymous speech, encryption)"],
        "key_statutes": [
            "18 U.S.C. Section 2510 et seq. (Wiretap Act / ECPA Title I)",
            "18 U.S.C. Section 2701 et seq. (Stored Communications Act / ECPA Title II)",
            "18 U.S.C. Section 3121 et seq. (Pen Register Act / ECPA Title III)",
            "Carpenter v. United States, 585 U.S. 296 (2018) (cell phone location data)",
            "Riley v. California, 573 U.S. 373 (2014) (cell phone search incident to arrest)",
        ],
    },
    "journalism": {
        "title": "Know Your Rights: Journalism and Press Freedom",
        "primary_amendments": ["First Amendment (freedom of the press)",
                               "First Amendment (reporter's privilege, limited)"],
        "key_statutes": [
            "42 U.S.C. Section 2000aa (Privacy Protection Act -- newsroom searches)",
            "5 U.S.C. Section 552 (FOIA)",
            "State shield laws (vary by state -- approximately 40 states have some form)",
            "Branzburg v. Hayes, 408 U.S. 665 (1972) (reporter's privilege limits)",
        ],
    },
    "whistleblower": {
        "title": "Know Your Rights: Whistleblowing",
        "primary_amendments": ["First Amendment (limited for public employees, see Garcetti v. Ceballos)"],
        "key_statutes": [
            "5 U.S.C. Section 2302(b)(8) (Whistleblower Protection Act)",
            "15 U.S.C. Section 78u-6 (Dodd-Frank SEC Whistleblower Program)",
            "31 U.S.C. Section 3729-3733 (False Claims Act / qui tam)",
            "18 U.S.C. Section 1514A (Sarbanes-Oxley Section 806)",
            "State whistleblower protection statutes (vary by state)",
        ],
    },
}

# ---------------------------------------------------------------------------
# Cease-and-desist response configuration
# ---------------------------------------------------------------------------

THREAT_DEFENSES = {
    "defamation": {
        "name": "Defamation / Libel Threat",
        "primary_defenses": [
            "Truth (absolute defense in all U.S. jurisdictions)",
            "Opinion (protected under First Amendment; Milkovich v. Lorain Journal Co., 497 U.S. 1 (1990))",
            "Fair report privilege (accurate report of official proceedings)",
            "Public figure doctrine (New York Times Co. v. Sullivan, 376 U.S. 254 (1964) -- actual malice required)",
            "Anti-SLAPP statute (if applicable in jurisdiction)",
        ],
        "key_statutes": [
            "U.S. Const. amend. I (free speech)",
            "New York Times Co. v. Sullivan, 376 U.S. 254 (1964)",
            "Milkovich v. Lorain Journal Co., 497 U.S. 1 (1990)",
            "State anti-SLAPP statutes (e.g., Cal. Civ. Proc. Code Section 425.16)",
        ],
    },
    "copyright": {
        "name": "Copyright Infringement Threat",
        "primary_defenses": [
            "Fair use (17 U.S.C. Section 107 -- purpose, nature, amount, market effect)",
            "Facts and ideas are not copyrightable (Feist Publications v. Rural Telephone, 499 U.S. 340 (1991))",
            "De minimis use",
            "License or implied license",
            "First Amendment / transformative use (Campbell v. Acuff-Rose Music, 510 U.S. 569 (1994))",
        ],
        "key_statutes": [
            "17 U.S.C. Section 107 (fair use)",
            "17 U.S.C. Section 512 (DMCA safe harbors)",
            "Campbell v. Acuff-Rose Music, Inc., 510 U.S. 569 (1994)",
            "Google LLC v. Oracle America, Inc., 593 U.S. 1 (2021)",
        ],
    },
    "trademark": {
        "name": "Trademark Infringement Threat",
        "primary_defenses": [
            "Nominative fair use (New Kids on the Block v. News America Publishing, 971 F.2d 302 (9th Cir. 1992))",
            "Descriptive fair use (KP Permanent Make-Up v. Lasting Impression I, 543 U.S. 111 (2004))",
            "First Amendment protection for commentary and criticism",
            "No likelihood of confusion",
            "Parody (Louis Vuitton Malletier S.A. v. Haute Diggity Dog, 507 F.3d 252 (4th Cir. 2007))",
        ],
        "key_statutes": [
            "15 U.S.C. Section 1051 et seq. (Lanham Act)",
            "15 U.S.C. Section 1125(a) (false designation of origin)",
            "15 U.S.C. Section 1115(b)(4) (fair use defense)",
        ],
    },
    "subpoena": {
        "name": "Subpoena (for sources, data, or testimony)",
        "primary_defenses": [
            "Reporter's privilege (qualified, varies by jurisdiction)",
            "First Amendment right to anonymous speech (McIntyre v. Ohio Elections Commission, 514 U.S. 334 (1995))",
            "Undue burden / overbreadth (move to quash)",
            "Attorney-client privilege (if applicable)",
            "Work product doctrine (if applicable)",
            "State shield law (if applicable -- approximately 40 states)",
        ],
        "key_statutes": [
            "U.S. Const. amend. I (free speech, press)",
            "Branzburg v. Hayes, 408 U.S. 665 (1972)",
            "42 U.S.C. Section 2000aa (Privacy Protection Act)",
            "State shield laws (vary by jurisdiction)",
            "Fed. R. Civ. P. 45(d)(3) (motion to quash subpoena)",
        ],
    },
}

# ---------------------------------------------------------------------------
# Gatekeeper API interaction
# ---------------------------------------------------------------------------


def ask_gatekeeper(prompt, system="", temperature=0.3, max_tokens=4096):
    """Send a prompt to the gatekeeper AI API and return the result."""
    payload = {
        "prompt": prompt,
        "system": system or LEGAL_SYSTEM_PROMPT,
        "caller": "plugin:legal-automation",
        "temperature": temperature,
        "max_tokens": max_tokens,
        "timeout": 180,
    }
    data = json.dumps(payload).encode("utf-8")
    req = urllib.request.Request(
        f"{GATEKEEPER_URL}/submit-sync",
        data=data,
        headers={"Content-Type": "application/json"},
        method="POST",
    )
    try:
        with urllib.request.urlopen(req, timeout=190) as resp:
            body = json.loads(resp.read().decode("utf-8"))
            if body.get("status") == "completed":
                return body.get("result", "")
    except Exception:
        pass
    return None


# ---------------------------------------------------------------------------
# Action: foia-generate
# ---------------------------------------------------------------------------


def generate_foia(agency, subject, date_range="", specifics="", level="federal",
                  state="", request_fee_waiver=True, request_expedited=False):
    """Generate a FOIA or public records request letter."""

    if not agency:
        return {"error": "Missing required field: 'agency'", "error_code": "MISSING_FIELD"}
    if not subject:
        return {"error": "Missing required field: 'subject'", "error_code": "MISSING_FIELD"}

    # Determine statute framework
    statute_info = FOIA_STATUTES.get(level, FOIA_STATUTES["federal"])
    statute_name = statute_info["name"]
    statute_cite = statute_info["statute"]

    # State-specific statute if available
    state_statute = ""
    if level == "state" and state:
        state_upper = state.upper()[:2]
        state_statute = statute_info.get("common_statutes", {}).get(state_upper, "")

    # Agency contact lookup
    agency_upper = agency.upper()
    agency_contact = FEDERAL_AGENCY_FOIA_CONTACTS.get(agency_upper, agency)

    today = datetime.now(timezone.utc).strftime("%B %d, %Y")

    prompt = f"""Generate a complete, professional FOIA request letter with the following details:

REQUESTER INFORMATION:
- Date: {today}
- Agency: {agency_contact}
- Statute: {statute_cite} ({statute_name})
{f"- State-specific statute: {state_statute}" if state_statute else ""}

REQUEST DETAILS:
- Subject of request: {subject}
{f"- Date range: {date_range}" if date_range else ""}
{f"- Specific records sought: {specifics}" if specifics else ""}

INCLUDE THE FOLLOWING SECTIONS:
1. Formal salutation and opening paragraph citing the applicable statute
2. Detailed description of records requested, using "reasonable particularity"
3. Preferred format for records (electronic, if available)
{"4. Fee waiver request citing " + statute_info.get("fee_waiver_basis", "public interest") if request_fee_waiver else ""}
{"5. Request for expedited processing citing " + statute_info.get("expedited_basis", "compelling need") if request_expedited else ""}
6. Statement of willingness to pay reasonable fees (if fee waiver denied), up to $25 without prior notification
7. Request for Vaughn index if any records are withheld
8. Statement of right to appeal under {statute_info.get("appeal_statute", "applicable law")}
9. Contact information placeholders ([YOUR NAME], [YOUR ADDRESS], [YOUR EMAIL], [YOUR PHONE])
10. Formal closing

The letter must be:
- Formally worded but readable
- Legally precise in its citations
- Specific enough to be actionable but broad enough to capture relevant records
- Ready to send after filling in requester details

Generate ONLY the letter text, no commentary."""

    content = ask_gatekeeper(prompt, temperature=0.2, max_tokens=4096)
    if not content:
        # Fallback: generate a basic template without AI
        content = _foia_fallback_template(
            agency_contact, subject, date_range, specifics,
            statute_cite, statute_name, today, request_fee_waiver
        )

    # Build metadata
    exemptions_to_watch = [
        "Exemption 5 (deliberative process) -- most commonly abused",
        "Exemption 7 (law enforcement) -- if subject involves investigations",
        "Exemption 4 (trade secrets) -- if subject involves contractors",
        "Exemption 6 (personal privacy) -- if subject involves individuals",
    ]

    return {
        "content": content,
        "type": "foia_request",
        "metadata": {
            "agency": agency,
            "agency_contact": agency_contact,
            "subject": subject,
            "date_range": date_range,
            "level": level,
            "statute": statute_cite,
            "statute_name": statute_name,
            "state_statute": state_statute or None,
            "generated_date": today,
            "fee_waiver_requested": request_fee_waiver,
            "expedited_requested": request_expedited,
        },
        "exemptions_to_watch": exemptions_to_watch,
        "next_steps": [
            "Fill in your name, address, email, and phone number in the bracketed placeholders.",
            f"Submit to the agency's FOIA office. Many agencies accept online submissions.",
            f"The agency must respond within {statute_info.get('response_deadline', '20 business days')}.",
            "If the agency does not respond, you may file an administrative appeal.",
            "If the appeal is denied, you may file a FOIA lawsuit in federal district court (5 U.S.C. Section 552(a)(4)(B)).",
            "Track your request. Consider filing with MuckRock (muckrock.com) for tracking and publication.",
            "Contact the Reporters Committee for Freedom of the Press (rcfp.org) if you need legal assistance.",
        ],
        "disclaimer": LEGAL_DISCLAIMER,
    }


def _foia_fallback_template(agency_contact, subject, date_range, specifics,
                            statute_cite, statute_name, today, fee_waiver):
    """Generate a basic FOIA template without AI assistance."""
    date_line = f"Records dated {date_range}. " if date_range else ""
    specifics_line = f"\nSpecifically, I request: {specifics}" if specifics else ""
    fee_section = ""
    if fee_waiver:
        fee_section = (
            "\n\nI request a fee waiver pursuant to 5 U.S.C. Section "
            "552(a)(4)(A)(iii). Disclosure is in the public interest because "
            "it is likely to contribute significantly to public understanding "
            "of government operations and is not primarily in my commercial interest."
        )

    return (
        f"[YOUR NAME]\n[YOUR ADDRESS]\n[YOUR EMAIL]\n[YOUR PHONE]\n\n{today}\n\n"
        f"FOIA Officer\n{agency_contact}\n\n"
        f"Re: {statute_name} Request -- {subject}\n\nDear FOIA Officer:\n\n"
        f"Pursuant to the {statute_name}, {statute_cite}, I request access to "
        f"and copies of all records, including documents, memoranda, correspondence, "
        f"emails, reports, and data files, relating to: {subject}. {date_line}"
        f"{specifics_line}\n\nI request records in electronic format where available."
        f"{fee_section}\n\nIf records are withheld, I request a Vaughn index. "
        f"I am willing to pay reasonable fees up to $25.00.\n\n"
        f"If denied, I intend to appeal under {statute_cite}.\n\nSincerely,\n\n[YOUR NAME]"
    )


# ---------------------------------------------------------------------------
# Action: complaint-draft
# ---------------------------------------------------------------------------


def draft_complaint(complaint_type, subject, facts=None, evidence=None):
    """Draft a regulatory complaint."""

    if not complaint_type:
        return {"error": "Missing required field: 'type'", "error_code": "MISSING_FIELD"}
    if not subject:
        return {"error": "Missing required field: 'subject'", "error_code": "MISSING_FIELD"}

    agency_info = COMPLAINT_AGENCIES.get(complaint_type)
    if not agency_info:
        valid = ", ".join(COMPLAINT_AGENCIES.keys())
        return {
            "error": f"Unknown complaint type: '{complaint_type}'. Valid types: {valid}",
            "error_code": "INVALID_INPUT",
        }

    facts_list = facts or []
    evidence_list = evidence or []

    facts_str = "\n".join(f"  {i+1}. {f}" for i, f in enumerate(facts_list)) if facts_list else "  (No specific facts provided -- add factual allegations)"
    evidence_str = "\n".join(f"  {i+1}. {e}" for i, e in enumerate(evidence_list)) if evidence_list else "  (No evidence listed -- attach supporting documentation)"

    statutes_str = "\n".join(f"  - {s}" for s in agency_info.get("additional_statutes", []))

    prompt = f"""Draft a formal regulatory complaint to the {agency_info['name']} regarding the following matter:

AGENCY: {agency_info['name']}
JURISDICTION: {agency_info['jurisdiction']}
PRIMARY STATUTE: {agency_info['statute']}
ADDITIONAL APPLICABLE STATUTES:
{statutes_str}

SUBJECT OF COMPLAINT: {subject}

FACTUAL ALLEGATIONS:
{facts_str}

SUPPORTING EVIDENCE:
{evidence_str}

STRUCTURE THE COMPLAINT AS FOLLOWS:
1. CAPTION -- Formal heading with agency name and "Complaint" designation
2. PARTIES -- Complainant (placeholder) and Respondent (the subject)
3. JURISDICTION AND AUTHORITY -- Cite the agency's statutory authority
4. STATEMENT OF FACTS -- Organized chronologically, numbered paragraphs
5. VIOLATIONS -- Specific statutory or regulatory provisions violated, with analysis
6. EVIDENCE -- Summary of supporting evidence with reference to attachments
7. RELIEF REQUESTED -- Specific actions requested (investigation, enforcement, penalties, injunction)
8. CONCLUSION -- Summary and request for prompt action
9. SIGNATURE BLOCK -- Placeholder for complainant information

The complaint must:
- Be formally structured like a real regulatory filing
- Cite specific statutory provisions with section numbers
- Present facts in numbered paragraphs
- Clearly connect facts to legal violations
- Request specific, concrete relief
- Be professional and evidence-based in tone

Generate ONLY the complaint text."""

    content = ask_gatekeeper(prompt, temperature=0.2, max_tokens=4096)
    if not content:
        content = _complaint_fallback(agency_info, subject, facts_str, evidence_str)

    return {
        "content": content,
        "type": "regulatory_complaint",
        "metadata": {
            "agency": agency_info["name"],
            "complaint_type": complaint_type,
            "subject": subject,
            "primary_statute": agency_info["statute"],
            "additional_statutes": agency_info.get("additional_statutes", []),
            "filing_url": agency_info.get("filing_url", ""),
            "fact_count": len(facts_list),
            "evidence_count": len(evidence_list),
            "generated_date": datetime.now(timezone.utc).strftime("%B %d, %Y"),
        },
        "next_steps": [
            f"Review the complaint carefully and verify all factual allegations.",
            f"Gather and organize all supporting evidence referenced in the complaint.",
            f"File the complaint through the agency portal: {agency_info.get('filing_url', 'see agency website')}",
            "Consider filing with multiple agencies if the conduct violates multiple regulatory frameworks.",
            "Keep copies of all submissions and correspondence.",
            "Consider consulting with an attorney, especially for SEC complaints (anonymous filing requires counsel).",
            "If filing with a state AG, search for your state's consumer complaint portal.",
            "Document any retaliation if you are an employee or insider reporting.",
        ],
        "disclaimer": LEGAL_DISCLAIMER,
    }


def _complaint_fallback(agency_info, subject, facts_str, evidence_str):
    """Generate a basic complaint template without AI assistance."""
    today = datetime.now(timezone.utc).strftime("%B %d, %Y")
    statutes = "\n".join(f"  - {s}" for s in agency_info.get("additional_statutes", []))
    return (
        f"BEFORE THE {agency_info['name'].upper()}\n\nCOMPLAINT\n\nDate: {today}\n\n"
        f"I. PARTIES\nComplainant: [YOUR NAME]\nRespondent: {subject}\n\n"
        f"II. JURISDICTION\nThe {agency_info['name']} has jurisdiction pursuant to "
        f"{agency_info['statute']}.\nAdditional authorities:\n{statutes}\n\n"
        f"III. FACTS\n{facts_str}\n\nIV. EVIDENCE\n{evidence_str}\n\n"
        f"V. RELIEF REQUESTED\n1. Investigate the described conduct;\n"
        f"2. Take appropriate enforcement action;\n"
        f"3. Impose authorized penalties or sanctions.\n\n"
        f"Respectfully submitted,\n\n[YOUR NAME]\n[YOUR ADDRESS]\n[YOUR EMAIL]"
    )


# ---------------------------------------------------------------------------
# Action: rights-card
# ---------------------------------------------------------------------------


def generate_rights_card(scenario, state=""):
    """Generate a know-your-rights information card."""

    if not scenario:
        return {"error": "Missing required field: 'scenario'", "error_code": "MISSING_FIELD"}

    scenario_info = RIGHTS_SCENARIOS.get(scenario)
    if not scenario_info:
        valid = ", ".join(RIGHTS_SCENARIOS.keys())
        return {
            "error": f"Unknown scenario: '{scenario}'. Valid scenarios: {valid}",
            "error_code": "INVALID_INPUT",
        }

    amendments_str = "\n".join(f"  - {a}" for a in scenario_info["primary_amendments"])
    statutes_str = "\n".join(f"  - {s}" for s in scenario_info["key_statutes"])
    state_note = f"\n\nSTATE-SPECIFIC: Generate rights information specific to {state} where applicable. Include state-specific statutes and protections." if state else ""

    prompt = f"""Generate a comprehensive know-your-rights information card for the following scenario:

SCENARIO: {scenario_info['title']}
{state_note}

CONSTITUTIONAL PROTECTIONS:
{amendments_str}

KEY STATUTES AND CASES:
{statutes_str}

STRUCTURE THE RIGHTS CARD AS FOLLOWS:

1. TITLE -- Bold, clear title

2. YOUR RIGHTS -- Numbered list of specific, actionable rights. Be concrete:
   not "you have the right to free speech" but "you have the right to
   photograph and record police officers performing their duties in public
   spaces (subject to reasonable time, place, and manner restrictions)."

3. DO -- Numbered list of concrete actions to take. Practical, specific,
   memorable. Include exact phrases to say (e.g., "I am exercising my
   right to remain silent. I want to speak to a lawyer.").

4. DO NOT -- Numbered list of actions to avoid. Be specific about why
   each is risky and what legal consequence could follow.

5. IF YOUR RIGHTS ARE VIOLATED -- Step-by-step instructions for documenting
   the violation and seeking remedy. Include specific organizations to contact.

6. EMERGENCY CONTACTS -- Placeholder section with categories:
   - National: ACLU, NLG Legal Observer Hotline, etc.
   - Local: [state/city specific legal aid]
   - Personal: [space for personal emergency contacts]

7. LEGAL CITATIONS -- Brief list of the most important citations for
   someone who wants to verify or learn more.

The card must be:
- Written in plain, direct language (8th grade reading level)
- Memorizable -- the key points should be short enough to remember
- Accurate in its legal citations
- Practical -- focused on what to DO, not abstract legal theory
- Empowering -- the reader should feel more capable after reading it

Generate ONLY the rights card content."""

    content = ask_gatekeeper(prompt, temperature=0.3, max_tokens=4096)
    if not content:
        content = _rights_card_fallback(scenario_info, state)

    emergency_contacts = {
        "ACLU": "aclu.org -- National and state chapters",
        "National Lawyers Guild": "nlg.org -- Legal observer hotlines for protests",
        "Electronic Frontier Foundation": "eff.org -- Digital rights and privacy",
        "Reporters Committee for Freedom of the Press": "rcfp.org -- Press freedom legal defense",
        "Government Accountability Project": "whistleblower.org -- Whistleblower support",
        "National Whistleblower Center": "whistleblowers.org -- Whistleblower legal assistance",
    }

    return {
        "content": content,
        "type": "rights_card",
        "metadata": {
            "scenario": scenario,
            "title": scenario_info["title"],
            "state": state or "general (not state-specific)",
            "primary_amendments": scenario_info["primary_amendments"],
            "key_statutes": scenario_info["key_statutes"],
            "generated_date": datetime.now(timezone.utc).strftime("%B %d, %Y"),
        },
        "emergency_contacts": emergency_contacts,
        "next_steps": [
            "Print this card and carry it with you.",
            "Share with others who may be in similar situations.",
            "Verify state-specific rights with a local attorney or legal aid organization.",
            "Program emergency legal hotline numbers into your phone.",
            "Consider attending a know-your-rights training (ACLU and NLG offer free sessions).",
            "Remember: knowing your rights is the first step; asserting them calmly is the second.",
        ],
        "disclaimer": LEGAL_DISCLAIMER,
    }


def _rights_card_fallback(scenario_info, state):
    """Generate a basic rights card without AI assistance."""
    amendments = "\n".join(f"  - {a}" for a in scenario_info["primary_amendments"])
    statutes = "\n".join(f"  - {s}" for s in scenario_info["key_statutes"])
    state_line = f"\nState: {state} -- Consult a local attorney for state-specific protections.\n" if state else ""
    return (
        f"{scenario_info['title'].upper()}\n\nCONSTITUTIONAL PROTECTIONS:\n{amendments}\n\n"
        f"KEY LEGAL AUTHORITIES:\n{statutes}\n\n"
        "YOUR CORE RIGHTS:\n"
        "1. You have the right to remain silent. Use it.\n"
        "2. You have the right to an attorney. Request one clearly.\n"
        "3. You have the right to refuse consent to searches.\n"
        "4. You have the right to record public officials in public spaces.\n"
        "5. You have the right to know why you are being detained.\n\n"
        "KEY PHRASES:\n"
        '- "I am exercising my right to remain silent."\n'
        '- "I do not consent to this search."\n'
        '- "Am I free to go, or am I being detained?"\n'
        '- "I want to speak to a lawyer."\n\n'
        "IF YOUR RIGHTS ARE VIOLATED:\n"
        "1. Stay calm. Do not physically resist.\n"
        "2. Document everything: names, badge numbers, time, location, witnesses.\n"
        "3. Contact the ACLU or a civil rights attorney.\n"
        f"{state_line}\nEMERGENCY CONTACTS:\n- ACLU: aclu.org\n"
        "- National Lawyers Guild: nlg.org\n- Your attorney: [fill in]"
    )


# ---------------------------------------------------------------------------
# Action: cease-desist-respond
# ---------------------------------------------------------------------------


def respond_to_threat(threat_type, original_text="", our_position=""):
    """Generate a response to a legal threat (cease-and-desist, etc.)."""

    if not threat_type:
        return {"error": "Missing required field: 'threat_type'", "error_code": "MISSING_FIELD"}

    defense_info = THREAT_DEFENSES.get(threat_type)
    if not defense_info:
        valid = ", ".join(THREAT_DEFENSES.keys())
        return {
            "error": f"Unknown threat type: '{threat_type}'. Valid types: {valid}",
            "error_code": "INVALID_INPUT",
        }

    defenses_str = "\n".join(f"  - {d}" for d in defense_info["primary_defenses"])
    statutes_str = "\n".join(f"  - {s}" for s in defense_info["key_statutes"])

    original_excerpt = original_text[:2000] if original_text else "(No original threat text provided)"

    prompt = f"""Draft a professional response letter to a {defense_info['name']} legal threat.

THREAT TYPE: {defense_info['name']}

ORIGINAL THREAT (excerpt):
{original_excerpt}

OUR POSITION:
{our_position or "(Position not specified -- generate a general defense template)"}

AVAILABLE LEGAL DEFENSES:
{defenses_str}

KEY LEGAL AUTHORITIES:
{statutes_str}

STRUCTURE THE RESPONSE AS FOLLOWS:

1. HEADER -- Professional letterhead placeholder, date, recipient information
2. RE LINE -- Clear identification of the threat being responded to
3. OPENING -- Professional acknowledgment of receipt, without conceding any point
4. FACTUAL RESPONSE -- Point-by-point response to the specific allegations,
   organized to correspond to the original threat's claims
5. LEGAL ANALYSIS -- Identification of applicable defenses with citations.
   Emphasize:
   - First Amendment protections where applicable
   - Anti-SLAPP statutes where applicable (note jurisdiction-specific applicability)
   - The specific substantive defenses listed above
6. COUNTERVAILING CONCERNS -- Where appropriate, note:
   - Public interest in the speech at issue
   - Potential Streisand effect
   - That aggressive pursuit of meritless claims may itself have legal consequences
   - Anti-SLAPP fee-shifting provisions where applicable
7. CONCLUSION -- Professional but firm statement that the claims lack merit,
   that the speech/conduct will continue (if appropriate), and preservation
   of all rights and defenses
8. SIGNATURE BLOCK -- Placeholder

The response must:
- Be professionally worded (this is a legal letter, not a blog post)
- Firmly assert rights without being inflammatory
- Cite actual statutes and case law accurately
- NOT concede any factual or legal point
- Preserve all defenses and rights
- Note that this is a preliminary response and that formal legal counsel is being consulted

Generate ONLY the response letter text."""

    content = ask_gatekeeper(prompt, temperature=0.2, max_tokens=4096)
    if not content:
        content = _threat_response_fallback(defense_info, original_excerpt, our_position)

    return {
        "content": content,
        "type": "cease_desist_response",
        "metadata": {
            "threat_type": threat_type,
            "defense_name": defense_info["name"],
            "primary_defenses": defense_info["primary_defenses"],
            "key_statutes": defense_info["key_statutes"],
            "original_text_length": len(original_text) if original_text else 0,
            "generated_date": datetime.now(timezone.utc).strftime("%B %d, %Y"),
        },
        "next_steps": [
            "CRITICAL: Have this response reviewed by a licensed attorney before sending.",
            "Do NOT ignore the threat -- even meritless threats require a timely response.",
            "Preserve all evidence: save the original threat, your publications, and all communications.",
            "Check if your state has an anti-SLAPP statute and whether it applies to your situation.",
            "Consider contacting the Electronic Frontier Foundation (eff.org) or ACLU for support.",
            "If the threat involves a subpoena, note the deadline carefully -- failure to respond can result in contempt.",
            "Document the chilling effect: the threat itself may be relevant in anti-SLAPP proceedings.",
            "Consider whether the threat constitutes abuse of process or malicious prosecution.",
        ],
        "disclaimer": LEGAL_DISCLAIMER,
    }


def _threat_response_fallback(defense_info, original_excerpt, our_position):
    """Generate a basic threat response without AI assistance."""
    today = datetime.now(timezone.utc).strftime("%B %d, %Y")
    defenses = "\n".join(f"  {i+1}. {d}" for i, d in enumerate(defense_info["primary_defenses"]))
    statutes = "\n".join(f"  - {s}" for s in defense_info["key_statutes"])
    pos = f"Our position: {our_position}" if our_position else "I write to respond to your claims."
    return (
        f"[YOUR NAME / ORGANIZATION]\n[YOUR ADDRESS]\n[YOUR EMAIL]\n\n{today}\n\n"
        f"VIA [EMAIL/CERTIFIED MAIL]\n\n[SENDER'S NAME]\n[SENDER'S ADDRESS]\n\n"
        f"Re: Response to Your {defense_info['name']} Communication\n\n"
        f"Dear [SENDER'S NAME]:\n\nI am in receipt of your communication dated "
        f"[DATE] regarding [DESCRIPTION].\n\n{pos}\n\n"
        f"LEGAL ANALYSIS\n\nThe claims are without merit:\n\n{defenses}\n\n"
        f"Applicable authorities:\n{statutes}\n\n"
        f"All rights, remedies, and defenses are reserved, including anti-SLAPP claims. "
        f"I am consulting with legal counsel.\n\nSincerely,\n\n[YOUR NAME]"
    )


# ---------------------------------------------------------------------------
# Action: public-comment
# ---------------------------------------------------------------------------


def generate_public_comment(docket, agency, position, facts=None):
    """Generate a public comment for a regulatory proceeding."""

    if not docket:
        return {"error": "Missing required field: 'docket'", "error_code": "MISSING_FIELD"}
    if not agency:
        return {"error": "Missing required field: 'agency'", "error_code": "MISSING_FIELD"}
    if not position:
        return {"error": "Missing required field: 'position'", "error_code": "MISSING_FIELD"}

    facts_list = facts or []
    facts_str = "\n".join(f"  {i+1}. {f}" for i, f in enumerate(facts_list)) if facts_list else "  (No specific facts provided)"

    prompt = f"""Draft a formal public comment for a regulatory proceeding.

AGENCY: {agency}
DOCKET NUMBER: {docket}
POSITION: {position}

SUPPORTING FACTS:
{facts_str}

STRUCTURE THE PUBLIC COMMENT AS FOLLOWS:

1. HEADER -- Standard regulatory comment format:
   "[COMMENTER NAME]
    Comments on [DOCKET NUMBER]
    [AGENCY NAME]
    [DATE]"

2. INTRODUCTION -- Identify the commenter (placeholder), state which
   rulemaking or proceeding the comment addresses (by docket number),
   and summarize the position in 1-2 sentences.

3. BACKGROUND AND INTEREST -- Explain why the commenter has standing
   or interest in this proceeding. Regulatory agencies give more weight
   to comments that demonstrate relevant expertise or direct impact.

4. SUBSTANTIVE COMMENTS -- Organized by specific provisions of the
   proposed rule or action. For each point:
   a. Identify the specific provision being addressed
   b. State the position (support, oppose, or request modification)
   c. Provide factual and legal basis for the position
   d. Cite relevant statutes, regulations, or precedents
   e. Propose specific alternative language where appropriate

5. LEGAL AND POLICY ARGUMENTS -- Broader arguments about the proceeding:
   - Administrative Procedure Act requirements (5 U.S.C. Section 553)
   - Arbitrary and capricious standard (5 U.S.C. Section 706(2)(A))
   - Cost-benefit analysis concerns
   - Statutory authority questions

6. CONCLUSION -- Restate position, request specific action, offer to
   provide additional information.

7. SIGNATURE -- Commenter identification placeholder

The comment must:
- Follow the formal structure expected by regulatory agencies
- Be substantive (agencies are required to consider and respond to substantive comments)
- Cite specific provisions of the proposed rule by section number where possible
- Present factual evidence and legal argument, not just opinion
- Be suitable for submission through regulations.gov or agency-specific portals
- Reference the Administrative Procedure Act's notice-and-comment requirements

Generate ONLY the public comment text."""

    content = ask_gatekeeper(prompt, temperature=0.2, max_tokens=4096)
    if not content:
        content = _public_comment_fallback(docket, agency, position, facts_str)

    return {
        "content": content,
        "type": "public_comment",
        "metadata": {
            "docket": docket,
            "agency": agency,
            "position": position,
            "fact_count": len(facts_list),
            "generated_date": datetime.now(timezone.utc).strftime("%B %d, %Y"),
            "apa_citation": "5 U.S.C. Section 553 (notice and comment rulemaking)",
            "judicial_review": "5 U.S.C. Section 706 (scope of judicial review)",
        },
        "next_steps": [
            "Review and customize the comment with your specific expertise and facts.",
            f"Submit through regulations.gov (search for docket {docket}) or the agency's portal.",
            "File before the comment deadline -- late comments may not be considered.",
            "Save your confirmation receipt after submitting.",
            "Consider submitting as part of a coalition for greater impact.",
            "Substantive comments create a record that courts can review if the rule is challenged.",
            "Under the APA, the agency must consider and respond to significant comments.",
            "If the agency finalizes a rule without addressing your comment, that may be grounds for judicial review.",
        ],
        "disclaimer": LEGAL_DISCLAIMER,
    }


def _public_comment_fallback(docket, agency, position, facts_str):
    """Generate a basic public comment without AI assistance."""
    today = datetime.now(timezone.utc).strftime("%B %d, %Y")
    return (
        f"[YOUR NAME / ORGANIZATION]\nComments on Docket No. {docket}\n"
        f"{agency}\n{today}\n\nRe: Docket No. {docket}\n\n"
        f"Dear Sir or Madam:\n\nI submit these comments pursuant to the "
        f"Administrative Procedure Act, 5 U.S.C. Section 553.\n\n"
        f"POSITION\n\n{position}\n\nFACTUAL BASIS\n\n{facts_str}\n\n"
        f"LEGAL CONSIDERATIONS\n\nThe agency must consider all relevant "
        f"factors and articulate a rational connection between facts and "
        f"choices. Motor Vehicle Mfrs. Ass'n v. State Farm, 463 U.S. 29 (1983). "
        f"Arbitrary and capricious action is reviewable under 5 U.S.C. "
        f"Section 706(2)(A).\n\nRespectfully submitted,\n\n"
        f"[YOUR NAME]\n[YOUR AFFILIATION]\n[YOUR EMAIL]"
    )


# ---------------------------------------------------------------------------
# Error handling and main dispatch
# ---------------------------------------------------------------------------


def emit_error(msg, code="INVALID_INPUT"):
    """Emit a JSON error and exit."""
    json.dump({"error": msg, "error_code": code, "disclaimer": LEGAL_DISCLAIMER},
              sys.stdout, indent=2)
    sys.exit(1)


def main():
    """Main dispatch: read JSON from stdin, route to action, write JSON to stdout."""
    try:
        raw = sys.stdin.read()
        if not raw.strip():
            emit_error(
                "No input provided. Send JSON with an 'action' field on stdin. "
                "Valid actions: foia-generate, complaint-draft, rights-card, "
                "cease-desist-respond, public-comment",
                "MISSING_FIELD",
            )
        input_data = json.loads(raw)
    except json.JSONDecodeError as e:
        emit_error(f"Invalid JSON input: {e}", "INVALID_INPUT")

    action = input_data.get("action", "")
    if not action:
        emit_error(
            "Missing 'action' field. Valid actions: foia-generate, complaint-draft, "
            "rights-card, cease-desist-respond, public-comment",
            "MISSING_FIELD",
        )

    if action == "foia-generate":
        result = generate_foia(
            agency=input_data.get("agency", ""),
            subject=input_data.get("subject", ""),
            date_range=input_data.get("date_range", ""),
            specifics=input_data.get("specifics", ""),
            level=input_data.get("level", "federal"),
            state=input_data.get("state", ""),
            request_fee_waiver=input_data.get("fee_waiver", True),
            request_expedited=input_data.get("expedited", False),
        )

    elif action == "complaint-draft":
        result = draft_complaint(
            complaint_type=input_data.get("type", ""),
            subject=input_data.get("subject", ""),
            facts=input_data.get("facts"),
            evidence=input_data.get("evidence"),
        )

    elif action == "rights-card":
        result = generate_rights_card(
            scenario=input_data.get("scenario", ""),
            state=input_data.get("state", ""),
        )

    elif action == "cease-desist-respond":
        result = respond_to_threat(
            threat_type=input_data.get("threat_type", ""),
            original_text=input_data.get("original_text", ""),
            our_position=input_data.get("our_position", ""),
        )

    elif action == "public-comment":
        result = generate_public_comment(
            docket=input_data.get("docket", ""),
            agency=input_data.get("agency", ""),
            position=input_data.get("position", ""),
            facts=input_data.get("facts"),
        )

    else:
        emit_error(
            f"Unknown action: '{action}'. Valid actions: foia-generate, "
            "complaint-draft, rights-card, cease-desist-respond, public-comment",
            "UNKNOWN_ACTION",
        )

    json.dump(result, sys.stdout, indent=2)
    if result.get("error"):
        sys.exit(1)


if __name__ == "__main__":
    main()
