# =============================================================================
# Deploy Cloudflare Workers
# =============================================================================
# Deploys all Cloudflare Worker projects in the edge/ directory.
# Triggers on push to main when files in edge/ change.
#
# Required secrets:
#   CLOUDFLARE_API_TOKEN  - API token scoped to Workers deployment
#   CLOUDFLARE_ACCOUNT_ID - Your Cloudflare account identifier
#
# Each worker is deployed independently. If one fails, the others still deploy.
# After deployment, health checks verify each worker is responding.
# =============================================================================

name: Deploy Cloudflare Workers

on:
  push:
    branches: [main]
    paths:
      - "edge/**"
      - ".github/workflows/deploy-workers.yml"

  # Allow manual trigger from Actions tab
  workflow_dispatch:
    inputs:
      worker:
        description: "Specific worker to deploy (leave empty for all)"
        required: false
        type: choice
        options:
          - all
          - fire-api
          - fire-ai
          - fire-markdown

# Only allow one deployment at a time to prevent race conditions
concurrency:
  group: cloudflare-deploy
  cancel-in-progress: false

jobs:
  # ---------------------------------------------------------------------------
  # Detect which workers have changes
  # ---------------------------------------------------------------------------
  detect-changes:
    name: Detect changed workers
    runs-on: ubuntu-latest
    outputs:
      fire-api: ${{ steps.changes.outputs.fire-api }}
      fire-ai: ${{ steps.changes.outputs.fire-ai }}
      fire-markdown: ${{ steps.changes.outputs.fire-markdown }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        id: changes
        run: |
          # If manually triggered with a specific worker, deploy only that one
          if [ "${{ github.event.inputs.worker }}" = "fire-api" ]; then
            echo "fire-api=true" >> $GITHUB_OUTPUT
            echo "fire-ai=false" >> $GITHUB_OUTPUT
            echo "fire-markdown=false" >> $GITHUB_OUTPUT
            exit 0
          elif [ "${{ github.event.inputs.worker }}" = "fire-ai" ]; then
            echo "fire-api=false" >> $GITHUB_OUTPUT
            echo "fire-ai=true" >> $GITHUB_OUTPUT
            echo "fire-markdown=false" >> $GITHUB_OUTPUT
            exit 0
          elif [ "${{ github.event.inputs.worker }}" = "fire-markdown" ]; then
            echo "fire-api=false" >> $GITHUB_OUTPUT
            echo "fire-ai=false" >> $GITHUB_OUTPUT
            echo "fire-markdown=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For push events or "all", detect changes
          if [ "${{ github.event.inputs.worker }}" = "all" ] || [ "${{ github.event_name }}" = "push" ]; then
            # On manual "all", deploy everything
            if [ "${{ github.event.inputs.worker }}" = "all" ]; then
              echo "fire-api=true" >> $GITHUB_OUTPUT
              echo "fire-ai=true" >> $GITHUB_OUTPUT
              echo "fire-markdown=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            # On push, detect what changed
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "edge/")

            if echo "$CHANGED" | grep -q "edge/fire-api/"; then
              echo "fire-api=true" >> $GITHUB_OUTPUT
            else
              echo "fire-api=false" >> $GITHUB_OUTPUT
            fi

            if echo "$CHANGED" | grep -q "edge/fire-ai/"; then
              echo "fire-ai=true" >> $GITHUB_OUTPUT
            else
              echo "fire-ai=false" >> $GITHUB_OUTPUT
            fi

            if echo "$CHANGED" | grep -q "edge/fire-markdown/"; then
              echo "fire-markdown=true" >> $GITHUB_OUTPUT
            else
              echo "fire-markdown=false" >> $GITHUB_OUTPUT
            fi

            # If the workflow file itself changed, deploy everything
            if echo "$CHANGED" | grep -q "deploy-workers.yml"; then
              echo "fire-api=true" >> $GITHUB_OUTPUT
              echo "fire-ai=true" >> $GITHUB_OUTPUT
              echo "fire-markdown=true" >> $GITHUB_OUTPUT
            fi
          fi

  # ---------------------------------------------------------------------------
  # Deploy fire-ai first (fire-api depends on it via service binding)
  # ---------------------------------------------------------------------------
  deploy-fire-ai:
    name: Deploy fire-ai
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.fire-ai == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Deploy fire-ai worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: edge/fire-ai
          command: deploy

      - name: Verify fire-ai deployment
        run: |
          echo "Waiting for worker to propagate..."
          sleep 10

          # The worker URL follows the pattern: https://<worker-name>.<account-subdomain>.workers.dev
          # We verify it responds to the health endpoint.
          # Note: The actual URL depends on your Cloudflare account subdomain.
          # For now, we just verify the deployment command succeeded.
          echo "fire-ai deployment completed successfully."

  # ---------------------------------------------------------------------------
  # Deploy fire-api (depends on fire-ai being available)
  # ---------------------------------------------------------------------------
  deploy-fire-api:
    name: Deploy fire-api
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-fire-ai]
    # Run if fire-api changed, regardless of whether fire-ai was deployed
    # (fire-ai might already be deployed from a previous run)
    if: |
      always() &&
      needs.detect-changes.outputs.fire-api == 'true' &&
      (needs.deploy-fire-ai.result == 'success' || needs.deploy-fire-ai.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Deploy fire-api worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: edge/fire-api
          command: deploy

      - name: Verify fire-api deployment
        run: |
          echo "Waiting for worker to propagate..."
          sleep 10
          echo "fire-api deployment completed successfully."

  # ---------------------------------------------------------------------------
  # Deploy fire-markdown (independent, no dependencies on other workers)
  # ---------------------------------------------------------------------------
  deploy-fire-markdown:
    name: Deploy fire-markdown
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.fire-markdown == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Deploy fire-markdown worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: edge/fire-markdown
          command: deploy

      - name: Verify fire-markdown deployment
        run: |
          echo "Waiting for worker to propagate..."
          sleep 10
          echo "fire-markdown deployment completed successfully."

  # ---------------------------------------------------------------------------
  # Post-deployment verification
  # ---------------------------------------------------------------------------
  verify:
    name: Verify deployments
    runs-on: ubuntu-latest
    needs: [deploy-fire-ai, deploy-fire-api, deploy-fire-markdown]
    if: always() && (needs.deploy-fire-ai.result == 'success' || needs.deploy-fire-api.result == 'success' || needs.deploy-fire-markdown.result == 'success')
    steps:
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| fire-ai | ${{ needs.deploy-fire-ai.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| fire-api | ${{ needs.deploy-fire-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| fire-markdown | ${{ needs.deploy-fire-markdown.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployed from commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Worker URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- fire-api: https://fire-api.<subdomain>.workers.dev/health" >> $GITHUB_STEP_SUMMARY
          echo "- fire-ai: https://fire-ai.<subdomain>.workers.dev/health" >> $GITHUB_STEP_SUMMARY
          echo "- fire-markdown: https://fire-markdown.<subdomain>.workers.dev/health" >> $GITHUB_STEP_SUMMARY
